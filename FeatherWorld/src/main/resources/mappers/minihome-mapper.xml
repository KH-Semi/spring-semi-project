<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.featherworld.project.miniHome.model.mapper.MiniHomeMapper">

	<select id="findMember" parameterType="_int" resultType="Member">
		SELECT * FROM MEMBER WHERE MEMBER_NO = #{memberNo}
	</select>

	<select id="findIlchon" parameterType="Ilchon" resultType="_int">
		SELECT COUNT(*) 
		FROM ILCHON
		WHERE FROM_MEMBER_NO = #{fromMemberNo} AND TO_MEMBER_NO = #{toMemberNo}
	</select>

	<!-- 최근 게시글 조회 (Oracle 서브쿼리 방식) -->
	<select id="selectRecentBoards" parameterType="_int" resultType="MiniHomeRecentBoard">
		SELECT * FROM (
			SELECT BOARD_NO AS boardNo,
				   BOARD_TITLE AS boardTitle,
				   BOARD_WRITE_DATE AS boardDate
			FROM BOARD 
			WHERE MEMBER_NO = #{memberNo}
			ORDER BY BOARD_WRITE_DATE DESC
		) WHERE ROWNUM <![CDATA[<=]]> 5
	</select>

	<!-- 일촌평 리스트 -->
	<select id="selectIlchonComments" parameterType="_int" resultType="IlchonComment">
		SELECT IC.TO_MEMBER_NO AS toMemberNo,
			   IC.FROM_MEMBER_NO AS fromMemberNo,
			   IC.ILCHON_COMMENT_CONTENT AS ilchonCommentContent,
			   M.MEMBER_NAME AS fromMemberName,
			   P.IMG_RENAME AS fromMemberImg
		FROM ILCHON_COMMENT IC
		JOIN MEMBER M ON IC.FROM_MEMBER_NO = M.MEMBER_NO
		LEFT JOIN PROFILE P ON M.MEMBER_NO = P.MEMBER_NO
		WHERE IC.TO_MEMBER_NO = #{memberNo}
		ORDER BY IC.ILCHON_COMMENT_CONTENT DESC
	</select>

	<select id="findmember" parameterType="_int" resultType="Member">
		SELECT MEMBER_NO, MEMBER_NAME, MEMBER_EMAIL, MEMBER_IMG,
			   MEMBER_INTRO, HOME_TITLE
		FROM MEMBER 
		WHERE MEMBER_NO = #{memberNo}
		  AND MEMBER_DEL_FL = 'N'
	</select>
	
	<select id="findilchon" parameterType="Ilchon" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE TO_MEMBER_NO = #{toMemberNo}
		  AND FROM_MEMBER_NO = #{fromMemberNo}
	</select>	
	
	<!-- 방문자 기록 추가 -->
	<insert id="todayAdd" parameterType="Today">
		INSERT INTO TODAY (HOME_NO, VISIT_NO, VISIT_DATE)
		VALUES (#{homeNo}, #{visitNo}, TRUNC(SYSDATE))
	</insert>	
	
	<!-- 오늘 특정 미니홈에 방문했는지 확인 -->
	<select id="todayConfirm" parameterType="Today" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{homeNo}
		  AND VISIT_NO = #{visitNo}
		  AND VISIT_DATE = TRUNC(SYSDATE)
	</select>
	
	<!-- 특정 미니홈의 오늘 총 방문자 수 조회 -->
	<select id="todayCount" parameterType="Today" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{homeNo}
		  AND VISIT_DATE = TRUNC(SYSDATE)
	</select>
	
	<!-- 특정 미니홈의 전체 방문자수 -->
	<select id="totalCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{memberNo}
	</select>
	
	<!-- 팔로워 수 조회 (남이 나를 일촌신청한 수) -->
	<select id="getFollowerCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE TO_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'Y'
	</select>

	<!-- 팔로잉 수 조회 (내가 남에게 일촌신청한 수) -->
	<select id="getFollowingCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE FROM_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'Y'
	</select>
	
	<!-- 미수락 팔로워 신청 수 조회 (남이 나에게 일촌신청했는데 아직 승인 안한 것) -->
	<select id="getPendingFollowerCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE TO_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'N'
	</select>
	
	<!-- 일촌 신청 보내기 -->
	<insert id="sendFollowRequest" parameterType="Ilchon">
		INSERT INTO ILCHON (
			FROM_MEMBER_NO, 
			TO_MEMBER_NO, 
			FROM_NICKNAME, 
			TO_NICKNAME, 
			IS_ILCHON
		) VALUES (
			#{fromMemberNo},
			#{toMemberNo},
			#{fromNickname},
			#{toNickname},
			'N'
		)
	</insert>

	<!-- 대기중인 일촌 신청 조회 (IS_ILCHON='N'인 것만) -->
	<select id="findPendingIlchon" parameterType="Ilchon" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON 
		WHERE FROM_MEMBER_NO = #{fromMemberNo} 
		  AND TO_MEMBER_NO = #{toMemberNo}
		  AND IS_ILCHON = 'N'
	</select>
	
	<!-- 수락된 일촌 관계만 조회 (IS_ILCHON='Y') -->
	<select id="findAcceptedIlchon" parameterType="Ilchon" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON 
		WHERE FROM_MEMBER_NO = #{fromMemberNo} 
		  AND TO_MEMBER_NO = #{toMemberNo}
		  AND IS_ILCHON = 'Y'
	</select>

</mapper>