<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.featherworld.project.miniHome.model.mapper.MiniHomeMapper">
		
			<!-- 일촌관계확인 -->
	<select id="findIlchon" parameterType="Ilchon" resultType="_int">
		  SELECT COUNT(*) 
   		  FROM ILCHON 
          WHERE IS_ILCHON_FL = 'Y'
          AND (
          (FROM_MEMBER_NO = #{fromMemberNo} AND TO_MEMBER_NO = #{toMemberNo})
          OR 
          (FROM_MEMBER_NO = #{toMemberNo} AND TO_MEMBER_NO = #{fromMemberNo})
      )
	</select>

	
 		<!-- 일촌평 -->
		<select id="getIlchonComments" parameterType="int" resultType="IlchonComment">
  		     SELECT 
             IC.TO_MEMBER_NO AS toMemberNo,
      	     IC.FROM_MEMBER_NO AS fromMemberNo,
       		 IC.ILCHON_COMMENT_CONTENT AS ilchonCommentContent,
       		 M.MEMBER_NAME AS fromMemberName,
       		 M.MEMBER_IMG AS fromMemberImg
    			FROM ILCHON_COMMENT IC
    			JOIN MEMBER M ON IC.FROM_MEMBER_NO = M.MEMBER_NO
    			WHERE IC.TO_MEMBER_NO = #{memberNo}
      			AND EXISTS (
          		SELECT 1 
          		FROM ILCHON I 
          		WHERE I.IS_ILCHON = 'Y'
            	AND (
                (I.FROM_MEMBER_NO = IC.FROM_MEMBER_NO AND I.TO_MEMBER_NO = IC.TO_MEMBER_NO)
                OR 
                (I.FROM_MEMBER_NO = IC.TO_MEMBER_NO AND I.TO_MEMBER_NO = IC.FROM_MEMBER_NO)
            		)
      			)
    			ORDER BY IC.FROM_MEMBER_NO
		</select>

		<select id="findmember" parameterType="_int" resultType="Member">
		SELECT MEMBER_NO, MEMBER_NAME, MEMBER_EMAIL, MEMBER_IMG,
			   MEMBER_INTRO, HOME_TITLE
		FROM MEMBER 
		WHERE MEMBER_NO = #{memberNo}
		  AND MEMBER_DEL_FL = 'N'
		</select>
		
	
	<!-- 방문자 기록 추가 -->
	<insert id="todayAdd" parameterType="Today">
		INSERT INTO TODAY (HOME_NO, VISIT_NO, VISIT_DATE)
		VALUES (#{homeNo}, #{visitNo}, TRUNC(SYSDATE))
	</insert>	
	
	<!-- 오늘 특정 미니홈에 방문했는지 확인 -->
	<select id="todayConfirm" parameterType="Today" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{homeNo}
		  AND VISIT_NO = #{visitNo}
		  AND VISIT_DATE = TRUNC(SYSDATE)
	</select>
	
	<!-- 특정 미니홈의 오늘 총 방문자 수 조회 -->
	<select id="todayCount" parameterType="Today" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{homeNo}
		  AND VISIT_DATE = TRUNC(SYSDATE)
	</select>
	
	<!-- 특정 미니홈의 전체 방문자수 -->
	<select id="totalCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM TODAY
		WHERE HOME_NO = #{memberNo}
	</select>
	
	<!-- 팔로워 수 조회 (남이 나를 일촌신청한 수) -->
	<select id="getFollowerCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE TO_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'Y'
	</select>

	<!-- 팔로잉 수 조회 (내가 남에게 일촌신청한 수) -->
	<select id="getFollowingCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE FROM_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'Y'
	</select>
	
	<!-- 미수락 팔로워 신청 수 조회 (남이 나에게 일촌신청했는데 아직 승인 안한 것) -->
	<select id="getPendingFollowerCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON
		WHERE TO_MEMBER_NO = #{memberNo}
		  AND IS_ILCHON = 'N'
	</select>
	
	<!-- 일촌 신청 보내기 -->
	<insert id="sendFollowRequest" parameterType="Ilchon">
		INSERT INTO ILCHON (
			FROM_MEMBER_NO, 
			TO_MEMBER_NO, 
			FROM_NICKNAME, 
			TO_NICKNAME, 
			IS_ILCHON
		) VALUES (
			#{fromMemberNo},
			#{toMemberNo},
			#{fromNickname},
			#{toNickname},
			'N'
		)
	</insert>

	<!-- 대기중인 일촌 신청 조회 (IS_ILCHON='N'인 것만) -->
	<select id="findPendingIlchon" parameterType="Ilchon" resultType="int">
    SELECT COUNT(*)
    FROM ILCHON
    WHERE FROM_MEMBER_NO = #{fromMemberNo}
      AND TO_MEMBER_NO = #{toMemberNo}
      AND IS_ILCHON = 'N'
	</select>
	
	<!-- 수락된 일촌 관계만 조회 (IS_ILCHON='Y') -->
	<select id="findAcceptedIlchon" parameterType="Ilchon" resultType="_int">
		SELECT COUNT(*)
		FROM ILCHON 
		WHERE FROM_MEMBER_NO = #{fromMemberNo} 
		  AND TO_MEMBER_NO = #{toMemberNo}
		  AND IS_ILCHON = 'Y'
	</select>
	 
	 <!--  최근 게시글 목록 조회 -->
		<select id="getRecentBoards" parameterType="int" resultType="Board">
        SELECT 
        BOARD_NO as boardNo,
        BOARD_TITLE as boardTitle,
        BOARD_CODE as boardCode,
        'test.jpg' as thumbnail
   		 FROM BOARD
  		  WHERE MEMBER_NO = #{memberNo}
    		    AND BOARD_DEL_FL = 'N'
  		    	AND ROWNUM &lt;= 6
  			    ORDER BY BOARD_NO DESC
			</select>
		
		   <!-- 총 게시글 수 조회 -->
  		<select id="getTotalBoardCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE MEMBER_NO = #{memberNo}
          AND BOARD_DEL_FL = 'N'
  		</select>
  		
  		   <!-- 총 방명록 수 조회 -->
    	<select id="getTotalGuestBookCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM GUEST_BOOK
        WHERE OWNER_NO = #{memberNo}
    	</select>
		
		
		  	<!-- 일촌평 작성 -->
			<insert id="insertIlchonComment" parameterType="IlchonComment">
   			   INSERT INTO ILCHON_COMMENT (
     		   FROM_MEMBER_NO,
     		   TO_MEMBER_NO,
    		   ILCHON_COMMENT_CONTENT
 			   )
    		SELECT #{fromMemberNo}, #{toMemberNo}, #{ilchonCommentContent}
   			 FROM DUAL
  			  WHERE EXISTS (
       		 SELECT 1 
      		  FROM ILCHON 
       		  WHERE IS_ILCHON = 'Y' 
          	  AND (
              (FROM_MEMBER_NO = #{fromMemberNo} AND TO_MEMBER_NO = #{toMemberNo})
              OR 
              (FROM_MEMBER_NO = #{toMemberNo} AND TO_MEMBER_NO = #{fromMemberNo})
         		 )
			    		)
			</insert>
	
		<!-- 일촌평 삭제 -->
		<delete id="deleteIlchonComment" parameterType="IlchonComment">
    	DELETE FROM ILCHON_COMMENT 
    	WHERE FROM_MEMBER_NO = #{fromMemberNo} 
        AND TO_MEMBER_NO = #{toMemberNo}
		</delete>
		
		<!-- 기존 일촌평 존재 여부 확인 -->
		<select id="checkExistingIlchonComment" parameterType="IlchonComment" resultType="int">
  		  SELECT COUNT(*) 
   		  FROM ILCHON_COMMENT 
  		  WHERE FROM_MEMBER_NO = #{fromMemberNo} 
    	  AND TO_MEMBER_NO = #{toMemberNo}
		</select>

		<!-- 일촌평 수정 -->
	<update id="updateIlchonComment" parameterType="IlchonComment">
    UPDATE ILCHON_COMMENT 
    SET ILCHON_COMMENT_CONTENT = #{ilchonCommentContent}
    WHERE FROM_MEMBER_NO = #{fromMemberNo} 
      AND TO_MEMBER_NO = #{toMemberNo}
	</update>



</mapper>